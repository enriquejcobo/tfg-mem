%---------------------------------------------------------------------
%
%                          Capítulo 6
%
%---------------------------------------------------------------------

\chapter{Pruebas y Resultados}
\label{cap:pruebas}

\begin{FraseCelebre}
\begin{Frase}
Hay una forma de hacerlo mejor \\
--encuéntrala.
\end{Frase}
\begin{Fuente}
Thomas Alva Edison
\end{Fuente}
\end{FraseCelebre}

\begin{resumen}
En este capítulo se presentan las pruebas que fueron realizadas a los diferentes elementos que conforman nuestro sistema, desde el doble punto de vista del \textit{hardware} y del \textit{software}. Los resultados de las mismas, así como las particularidades encontradas, son igualmente detalladas. Finalmente se resumen las principales herramientas usadas con este propósito. 
\end{resumen}

%-------------------------------------------------------------------
\section{Hardware}
%-------------------------------------------------------------------
\label{pruebas:sec:hardware}
%-------------------------------------------------------------------

A continuación se presentan las pruebas que se realizaron desde el punto de vista del comportamiento \textit{hardware} a tanto los dispositivos como a la placa en la que se enmarcan.

%-------------------------------------------------------------------
\subsection{Sensores y Actuadores}
%-------------------------------------------------------------------
\label{pruebas:sec:hardsensores}
%-------------------------------------------------------------------

Detallamos en primer lugar las pruebas realizadas a los sensores de forma individual antes de ser incluidos, comenzando por el sensor de \textbf{Luminosidad}. Para verificar el correcto funcionamiento del mismo, se realizó el montaje detallado en la figura \ref{diseno:fig:lum}, y se comprobó que, para distintos niveles de iluminación (aplicándole una fuente lumínica externa o cubriendo el detector) obteníamos a la salida distintos niveles de tensión, medidos en el osciloscopio. 

Asimismo, observamos que la adición del condensador reducía el ruido por rizado de alta frecuencia cuando la iluminación provenía de fuentes fluorescentes.

\medskip

A continuación procedemos a evaluar el sensor de \textbf{Presencia}. El circuito que implementamos es el de la figura \ref{diseno:fig:pir}, alimentado con las mismas tensiones que tendría en la placa, para lo cual hicimos uso de una fuente de alimentación. Conectando la sonda al pin de salida, observamos que la señal se ponía a nivel alto cuando pasábamos la mano sobre él, y que volvía a nivel bajo cuando la quitábamos.

No obstante, nos percatamos de que la adición de la resistencia de \textit{pull-down} nos introducía un efecto de carga en el nivel alto, si bien la tensión resultante no era mucho menor de la que se debía obtener al ser la resistencia de valor alto, por lo que concluimos la prueba satisfactoriamente.

\medskip

Las pruebas correspondientes a los sensores de \textbf{Temperatura} y \textbf{Acelerómetro} se exponen en el subapartado de \textit{software}, ya que necesitan de la interfaz \ac{I2C} para la obtención de resultados o modificación de parámetros. 

\medskip

En cuanto a los actuadores, comenzamos detallando el \textbf{Emisor Infrarrojo}. Para las pruebas con este dispositivo se hizo necesario un detector para la longitud de onda del mismo, por dos motivos. En primer lugar porque la luz que emite no es visible para el ojo humano y, en segundo lugar, aunque lo fuera, la modulación usada haría imposible la comprobación del buen funcionamiento. Es por ello que usamos el detector Vishay TSOP1138 \cite{detectorir}, siguiendo un montaje similar al que encontramos en la figura \ref{pruebas:fig:detectorir}.

\figuraEx{Bitmap/Capitulo6/detectorir}{width=.5\textwidth}{pruebas:fig:detectorir}%
{Detector infrarrojo Vishay TSOP1138, obtenido de \cite{detectorir}.}{Detector infrarrojo Vishay TSOP1138.}

Conectamos la salida de este detector a la sonda del osciloscopio, y alimentamos el circuito del \ac{IR} como ilustra la figura \ref{diseno:fig:ir}. Observamos que la salida del detector está a nivel alto cuando no recibe nada, y pasa a nivel bajo durante un instante cuando recibe señal de forma continuada. Este comportamiento es el esperado, por lo que la prueba es satisfactoria.

\medskip

Con los \textbf{LEDs} de propósito general, realizamos una prueba similar, alimentando el circuito de la figura \ref{diseno:fig:led}. En este caso todo es más sencillo, puesto que la luz emitida por estos \ac{LED} sí pertenece al rango visible, por lo que observamos que lucen perfectamente.

\medskip

No fue necesario realizar una prueba similar con el \textbf{Buzzer}, puesto que cuando este componente fue recibido ya estaba desarrollado el \textit{software} para el mismo, así que se probó en combinación con este.

%-------------------------------------------------------------------
\subsection{PCB}
%-------------------------------------------------------------------
\label{pruebas:sec:pcb}
%-------------------------------------------------------------------

Las pruebas realizadas en el ámbito de la \ac{PCB} fueron generalmente test eléctricos para comprobar la soldadura, o las conexiones entre pistas. Para ello se hizo indispensable la ayuda de un multímetro, que será detallado más abajo, en la sección \ref{pruebas:sec:multimetro}. Las mismas se detallan a continuación.

\begin{itemize}
\item En primer lugar se realizó una inspección óptica, comprobando que el trazado de la placa era el esperado.
\item Cuando se soldaba un dispositivo, como puede ser un sensor, un actuador o un componente, se realizaron pruebas de corto, en las cuales comprobamos que las conexiones entre patas del componente eran nulas, y que había cortocircuitos entre el pad del mismo y el siguiente punto de conexión en el circuito.
\item En caso de soldar resistencias, se usó el multímetro en posición de medir esta magnitud, de forma que comprobamos que el valor que aparecía en el medidor era similar al que debíamos obtener, con lo que verificábamos tanto una buena conexión como la inserción de la resistencia de valor adecuado.
\item Acciones similares eran seguidas con los condensadores, buscando los mismos propósitos que en el caso anterior. Para ello, se configuró el multímetro en posición de medir capacidades.
\end{itemize}

Una vez satisfechas todas las pruebas, la \ac{PCB} final ya podría ser sometida a pruebas de comportamiento del sistema.

%-------------------------------------------------------------------
\section{Software}
%-------------------------------------------------------------------
\label{pruebas:sec:software}
%-------------------------------------------------------------------

En este subapartado se detallan las pruebas hechas sobre el \textit{software} desarrollado, que ha sido objeto de estudio en el capítulo \ref{cap:software}. Las hemos clasificado en dos subapartados, las de la \ac{HAL} independientes y las que se han desarrollado en combinación con los sensores y los actuadores.

%-------------------------------------------------------------------
\subsection{HAL}
%-------------------------------------------------------------------
\label{pruebas:sec:hal}
%-------------------------------------------------------------------

Las pruebas realizadas sobre la \ac{HAL} consistieron en medidas sobre las distintas interfaces que iban a formar parte de nuestro sistema. Pasamos a detallarlas a continuación.

En primer lugar probamos el \textbf{\ac{ADC}}, cuya prueba consistió en formar un divisor de tensión por medio de resistencias conectadas a $V_{CC}$ y a GND, e introducir la tensión en distintos puntos en el \ac{ADC}, de forma que comprobamos que la palabra obtenida era la que correspondía.

En efecto, verificamos que las palabras en hexadecimal obtenidas cuando probamos con diferentes valores eran las que debían corresponder, por lo que determinamos que el funcionamiento era el correcto.

\medskip

Para los \textbf{\ac{GPIO}} de entrada, la prueba realizada para cada uno de ellos fue la de forzar un nivel alto, seguido de uno bajo, sobre las mismas, comprobando que el programa detectaba correctamente el nivel en el que se encontraba. 

Análogamente para los de salida, se programó un nivel alto seguido de uno bajo, con puntos de parada, verificando por medio del osciloscopio que se obtenía el citado estado cuando la ejecución del programa llegaba a los puntos donde se debían variar.

\medskip

Los actuadores que requieren la intervención de un temporizador, como son el \textbf{Emisor Infrarrojo} o el \textbf{Buzzer}, fueron probados de la siguiente manera. Se obtuvo la salida modulada que debían presentar, una señal cuadrada periódica de frecuencia 34 kHz para el caso del \ac{IR}, y 2 y 1.5 kHz para el caso del buzzer, y se introdujo esa señal en el osciloscopio, de forma que se midió la frecuencia.

%-------------------------------------------------------------------
\subsection{Funciones para el manejo de los sensores y actuadores}
%-------------------------------------------------------------------
\label{pruebas:sec:softsensores}
%-------------------------------------------------------------------

Por último, se presentan las pruebas realizadas a las funciones desarrolladas para el control de los sensores y actuadores. En este punto los sensores y actuadores ya estaban soldados y la placa colocada sobre el \ac{CNGD}, de forma que estos tests se llevaran a cabo bajo las mismas condiciones que tendrán en su entorno final.

En primer lugar presentamos las pruebas realizadas al sensor de \textbf{Temperatura}. En la sección \ref{software:sec:temp} presentamos el conjunto de funciones que necesita:

\begin{itemize}
\item \verb@getTemp@. Comprobamos que el sensor respondía a esta instrucción, y que el valor de temperatura devuelto se correspondía con el del entorno. Un aumento de temperatura fue forzado, y volvimos a repetir la medición, esta vez con un resultado superior.
\item \verb@setTempResolution@. Tras enviar este comando, procedimos a solicitar de nuevo la temperatura actual, observando en dicha medida que su precisión había aumentado conforme se le había indicado.
\item \verb@setTempAlert@ y \verb@getTempAlert@. Conocida la temperatura ambiente en el momento, e iniciando la prueba en una situación de no alarma, modificamos el valor de los registros de forma tal que este valor pasara a estar en la zona de peligro. Con la segunda función, comprobamos efectivamente que bajo estas nuevas condiciones se producía la alarma.
\end{itemize}

Seguidamente procedemos a evaluar el sensor de \textbf{Presencia}. Como se dijo en su sección del capítulo \ref{cap:software}, el estado de este sensor puede ser evaluado bien mediante \textit{polling}, preguntando periódicamente, o bien mediante la interrupción del puerto \ac{CN}.

En el primer caso, vimos que la función \verb@getPIR@ devolvía valores correctos en función de si detectaba presencia o no. Valor que, a su vez, estaba comprobándose paralelamente en el osciloscopio.

En el caso de la interrupción, dejamos corriendo el programa y situamos un punto de parada en la rutina de atención a la interrupción. Cuando el sensor detectó presencia, el programa entró en la misma, por lo que verificamos el funcionamiento correcto.

\medskip

Siguiendo con el sensor de \textbf{Luminosidad}, llevamos un proceso similar al visto en la sección \ref{pruebas:sec:hal}, comprobando que la tensión que se obtiene a la salida del sensor (medida por el osciloscopio) y la palabra resultante de la llamada a la función \verb@getLum@ son concordantes; siendo así en efecto.

\medskip

No se han podido comprobar las funciones del \textbf{Acelerómetro}, puesto que, como se puso de manifiesto en el capítulo \ref{cap:diseno} no llegó la versión definitiva de la placa al cierre de esta memoria. No obstante, se ha probado que los periféricos del \ac{MCU} que usa el acelerómetro sí funcionan, puesto que la interfaz \ac{I2C} ha sido testeada con éxito con el sensor de temperatura, y los \ac{CN} también han mostrado un comportamiento positivo en las pruebas desarrolladas con el \ac{PIR}.

\medskip

En cuando a los actuadores, comenzamos evaluando el \textbf{Emisor Infrarrojo}. Decidimos implementar el protocolo del aire acondicionado, debido a que la placa dispone de sensor de temperatura y puede conocer, por tanto, el valor de la misma en tiempo real.

Evaluando trabajos previos \cite{javipfc}, obtenemos que la información en las tramas del aire acondicionado se organiza de la siguiente manera: En primer lugar en 2 bytes se codifica el dispositivo, seguido de un byte de protección frente a errores, el comando a mandar --con tamaño variable-- y, por último, su código redundante. La figura \ref{software:fig:bitstrama} muestra en detalle la información contenida en la trama.

\figuraEx{Bitmap/Capitulo7/bitstrama}{width=.8\textwidth}{software:fig:bitstrama}%
{Contenido de la trama del aire acondicionado.}{Contenido de la trama del aire acondicionado.}

Los bytes que forman las tramas fueron decodificados por medio de la inspección de la trama enviada por el mando original, usando el receptor y presentando dicha trama en el osciloscopio, realizando ingeniería inversa. La figura \ref{pruebas:fig:tramaaa} muestra en detalle este proceso con una trama. A partir del análisis de varias tramas en las que se modificaba algún parámetro (conocido), procedimos a identificar la posición de los mismos dentro de la trama, observando manualmente qué bits eran los que cambiaban su estado. Para este propósito requerimos el uso de una hoja de cálculo. 

\figuraEx{Bitmap/Capitulo6/tramaaa}{width=.7\textwidth}{pruebas:fig:tramaaa}%
{Detalle del comienzo de trama infrarroja.}{Detalle del comienzo de trama infrarroja.}

La función \verb@void protocoloAA ()@ implementa el protocolo del aire acondicionado. Asimismo, en la función \verb@sendIR@, expuesta en el apartado \ref{software:sec:ir}, los argumentos serían \verb@AA@ para el dispositivo, \verb@modo@ (que indica si se quiere entrar en modo verano, \verb@AA_Summer@, o invierno, \verb@AA_Winter@) para el primer parámetro, y \verb@estado@ (que enciende el aparato, \verb@AA_On@, o lo apaga, \verb@AA_Off@) para el segundo.

Las pruebas realizadas fueron el envío de los comandos ``Enciende Aire Acondicionado, modo Verano'' y ``Apaga Aire Acondicionado, modo Verano''. Estas tramas fueron reconocidas correctamente por el receptor de infrarrojos descrito en el apartado \ref{pruebas:sec:hardsensores}, y dieron lugar al encendido (y posterior apagado) de la máquina de aire acondicionado presente en el laboratorio.

\medskip

Por último, las pruebas realizadas al \textbf{Buzzer} y \textbf{LEDs} fueron el mandar el encendido y el apagado de los mismos, con las funciones ya descritas. En el caso del Buzzer, se obtuvieron dos pitidos que se alternaban cada medio segundo; y, para los LEDs, comprobamos que \verb@ledOn@ mantiene encendido el LED, \verb@ledOff@ lo apaga incondicionalmente, y \verb@ledToggle@ lo conmuta, apagándolo o encendiéndolo según el caso.

%-------------------------------------------------------------------
\section{Herramientas}
%-------------------------------------------------------------------
\label{pruebas:sec:herramientas}
%-------------------------------------------------------------------

Para la realización de estas pruebas ha sido necesario usar una serie de equipos que permitan obtener las medidas, como ha sido visto a lo largo del capítulo, por lo que se ahondará en ellas en los siguientes apartados.

Además, ha sido necesario usar las herramientas expuestas en la sección \ref{software:sec:herramientas}, dado que hemos hecho igualmente pruebas al \textit{software}. 

%-------------------------------------------------------------------
\subsection{Osciloscopio}
%-------------------------------------------------------------------
\label{pruebas:sec:osciloscopio}
%-------------------------------------------------------------------

El osciloscopio nos permite ver la forma de onda de las señales temporales que se introducen en él. En nuestro laboratorio encontramos el \textbf{Tektronix TDS5054B}, el cual nos permite, además, las siguientes funciones, útiles en nuestro trabajo.

\begin{itemize}
\item \emph{Cuatro canales de entrada}, con lo que se pueden introducir cuatro señales simultáneas.
\item \emph{Alto periodo de muestreo}, de hasta 5 millones de muestras por segundo.
\item \emph{Medidas de parámetros de señal}, como pueden ser la frecuencia en señales periódicas, la amplitud, entre otras.
\item \emph{Disparo}, que permite que las señales periódicas permanecen congeladas en la pantalla. De especial ayuda resultó el modo \textit{single}, el cual únicamente esperaba a recibir una trama, reteniéndola en la pantalla y permitiendo su evaluación.
\item \emph{Cursores}, que ofrecen la posibilidad de realizar medidas de distancia entre dos puntos, útil para calcular los tiempos de nivel alto y bajo en las señales moduladas.
\item \emph{Zoom}, que amplía el sector que se desea evaluar para tener una mejor visión del mismo, usado en tramas largas como las del \ac{IR}.
\item \emph{Capturas de pantalla}, de forma que los resultados son exportables y presentables en otros documentos.
\end{itemize}

%-------------------------------------------------------------------
\subsection{Multímetro}
%-------------------------------------------------------------------
\label{pruebas:sec:multimetro}
%-------------------------------------------------------------------

El multímetro es un dispositivo que permite medir las principales magnitudes eléctricas, como son la tensión, la corriente, la resistencia o la capacidad. Especialmente de utilidad han sido las dos últimas, como ha sido detallado. 


% Variable local para emacs, para  que encuentre el fichero maestro de
% compilación y funcionen mejor algunas teclas rápidas de AucTeX
%%%
%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../Tesis.tex"
%%% End:
