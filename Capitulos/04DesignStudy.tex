%---------------------------------------------------------------------
%
%                          Capítulo 4
%
%---------------------------------------------------------------------

\chapter{Estudio del Diseño y de la Implementación}
\label{cap:diseno}

\begin{FraseCelebre}
\begin{Frase}
El conocimiento, si no se sabe aplicar,\\
es peor que la ignorancia.
\end{Frase}
\begin{Fuente}
Charles Bukowski
\end{Fuente}
\end{FraseCelebre}

\begin{resumen}
In this chapter, the platform design is described. The design decisions, specifications, schemes and needed calculations will be exposed.
The detailed characteristics of any chosen component, (including microcontroller, radio interfaces, and power-supply options) will be provided.
\end{resumen}

%-------------------------------------------------------------------
\section{Elección de sensores y actuadores}
%-------------------------------------------------------------------
\label{diseno:sec:eleccion}
%-------------------------------------------------------------------

Con los conocimientos adquiridos durante la realización del capítulo \ref{cap:previo}, pasamos a seleccionar los componentes que formarán de forma definitiva nuestra placa de expansión. La estructura que se seguirá en los siguientes subapartados se presenta a continuación.

\begin{enumerate}

\item Elegimos, de manera justificada, el sensor o actuador comercial que se ajusta mejor a las necesidades del problema a resolver.
\item Se presentará un diagrama de bloques que ilustre el modo de operación interno del mismo, así como un diagrama de pines y las señales de entrada y salida.
\item Finalmente, se detallarán y se justificarán los componentes adicionales que se han de incluir.

\end{enumerate}

%-------------------------------------------------------------------
\subsection{Sensores}
%-------------------------------------------------------------------
\label{diseno:sec:sensores}
%-------------------------------------------------------------------

En este apartado, se decidirán finalmente los sensores comerciales de los cuatro tipos expuestos en la sección \ref{previo:sec:sensores} que se incluirán y la forma en la que se colocarán, así como de la circuitería adicional que necesitan para funcionar.

%-------------------------------------------------------------------
\subsubsection{Temperatura}
%-------------------------------------------------------------------
\label{diseno:sec:temperatura}
%-------------------------------------------------------------------

De los modelos presentados en la tabla \ref{previo:tab:temp}, decidimos escoger el \textbf{Microchip MCP9800} \cite{mcp9800}, principalmente por ser el de mayor precisión con un precio asequible. Sus características detalladas se exponen a continuación.

\begin{multicols}{2}
\begin{itemize}
\item Precisión típica de $\pm$0.5ºC a 25ºC.
\item Error máximo de $\pm$1ºC entre -10ºC y 85ºC.
\item Resolución seleccionable de 9-12 bits.
\item Conexión I$^2$C.
\item Corriente de operación típica de 200 $\mu$A.
\item Corriente de apagado máxima de 1 $\mu$A.
\item Salida independiente configurable (ALERTA).
\end{itemize}
\end{multicols}

La figura \ref{diseno:fig:temp} muestra las entradas y salidas del sensor por medio de su diagrama de pines, así como el circuito que precisa para funcionar. 

\figuraEx{Bitmap/Capitulo4/temp}{width=.5\textwidth}{diseno:fig:temp}%
{Sensor de Temperatura Microchip MCP9800.}{Sensor de Temperatura Microchip MCP9800.}

Comentamos brevemente la adición de los componentes añadidos. En la etapa de entrada encontramos R12 y C5, cuya función es de actuar a modo de filtro paso bajo ante el posible ruido procedente de la alimentación. R11 es una resistencia de \textit{pull-up}, necesaria ya que la salida es de colector abierto. Además de esta resistencia, y con este mismo propósito, se incluyen dos resistencias R1 y R2 de \textit{pull-up} para la conexión por I$^2$C.



%-------------------------------------------------------------------
\subsubsection{Acelerómetro}
%-------------------------------------------------------------------
\label{diseno:sec:acelerometro}
%-------------------------------------------------------------------

En base al análisis realizado en la sección \ref{previo:sec:acelerometro}, en el que se presentaban los distintos sensores comerciales estudiados, seleccionamos el \textbf{Freescale MMA8453Q} \cite{mma8453q} por ser el más económico que cumple las especificaciones. A continuación detallamos todas sus características:

\begin{itemize}
\item Fondos de escala seleccionables $\pm$2g, $\pm$4g y $\pm$8g.
\item Resolución seleccionable de 8-10 bits.
\item Conexión I$^2$C.
\item Modos de bajo consumo.
\item Consumo de corriente de entre 6$\mu$A y 165$\mu$A.
\item Dos salidas programables para seis fuentes de interrupción.
	\begin{multicols}{2}
	\begin{itemize}
	\item Dato disponible.
	\item Pulso (\textit{tap}).
	\item Movimiento.
	\item Caída libre.
	\item Orientación.
	\item \textit{Auto-SLEEP}.
	\end{itemize}
	\end{multicols}
\end{itemize}

A continuación encontramos, en la figura \ref{diseno:fig:acc}, el diagrama de pines junto con el circuito requerido para su operación

\figuraEx{Bitmap/Capitulo4/acc}{width=.5\textwidth}{diseno:fig:acc}%
{Acelerómetro Freescale MMA8453Q.}{Acelerómetro Freescale MMA8453Q.}

En primer lugar, resaltar que el pin 3 no se encuentra en la figura. Esto es así puesto que el fabricante nos indica que no debe ir conectado. Además, hemos conectado a masa el pin 7 (SA0), que hace que el bit menos significativo de la dirección para el I$^2$C sea 0.

Comentamos a continuación los componentes del circuito. C1 y C2 son condensadores de desacoplo para las dos entradas de alimentación (principal e interfaz), mientras que el condensador C3 es denominado de \textit{bypass}. Al igual que como hemos comentado en el sensor de temperatura, son necesarias dos resistencias de \textit{pull-up} para la interfaz I$^2$C y que no aparecen en este esquema.


%-------------------------------------------------------------------
\subsubsection{Presencia}
%-------------------------------------------------------------------
\label{diseno:sec:presencia}
%-------------------------------------------------------------------

Siguiendo la misma línea que con los sensores anteriores, y en base a lo expuesto en la tabla \ref{previo:tab:pir}, seleccionamos como sensor de presencia el \textbf{Panasonic AMN33112J} \cite{amn} por ser el que mejor verificó una relación fiabilidad-precio. Sus características son:

\begin{itemize}
\item Salida binaria.
\item Detección de personas en hasta 3 metros.
\item Detección de movimientos de 30 centímetros.
\item Modos de bajo consumo.
\item Consumo en espera de 170 $\mu$A.
\item Consumo en detección de 270 $\mu$A.
\end{itemize}

El diagrama de pines se presenta en la figura \ref{diseno:fig:pir}. Como podemos ver, no es necesario un circuito adicional, se puede conectar directamente al microcontrolador.

\figuraEx{Bitmap/Capitulo4/pir}{width=.5\textwidth}{diseno:fig:pir}%
{Sensor de Presencia Panasonic AMN33112J.}{Sensor de Presencia Panasonic AMN33112J.}


%-------------------------------------------------------------------
\subsubsection{Luminosidad}
%-------------------------------------------------------------------
\label{diseno:sec:presencia}
%-------------------------------------------------------------------

Para finalizar, exponemos y justificamos la elección del sensor de luminosidad. Se trata, de los estudiados en la sección \ref{previo:sec:luminosidad}, del \textbf{Avago APDS 9005} \cite{apds9005}, por su bajo precio y responsividad similar a la del ojo humano. Sus características ampliadas serían:

\begin{itemize}
\item Salida analógica.
\item Fotocorriente con 10 lux de 19$\mu$A.
\item Fotocorriente con 100 lux de 230$\mu$A.
\item Corriente de oscuridad de 50 nA.
\item Tensión de saturación de $2.32$ V.
\end{itemize}

El diagrama de entradas y salidas del sensor lo encontramos en la figura \ref{diseno:fig:lum}. AL igual que en casos anteriores, los pines 2-5 no figuran al indicarse que no deben ser conectados a ningún punto.

\figuraEx{Bitmap/Capitulo4/lum}{width=.5\textwidth}{diseno:fig:lum}%
{Sensor de Luminosidad Avago APDS 9005.}{Sensor de Luminosidad Avago APDS 9005.}

De los compontentes que encontramos a la salida del sensor, justificamos la presencia de la resistencia R3 con el objeto de convertir la fotocorriente a tensión, de forma que puede ser introducida al \ac{ADC}. El valor de 10 K$\Omega$ hace que la tensión con 10 luxes sea de 1.9 V. El condensador C4 se pone con motivo de filtrar el rizado producido por fuentes de iluminación fluorescentes.

%-------------------------------------------------------------------
\subsection{Actuadores}
%-------------------------------------------------------------------
\label{diseno:sec:actuadores}
%-------------------------------------------------------------------

De forma similar a como hemos procedido con los sensores presentamos los actuadores que formarán nuestro sistema, partiendo de los requisitos analizados en la sección \ref{previo:sec:actuadores}.

%-------------------------------------------------------------------
\subsubsection{Emisor Infrarrojo}
%-------------------------------------------------------------------
\label{diseno:sec:ir}
%-------------------------------------------------------------------

El \ac{IR} escogido fue el \textbf{Vishay TSUS5202} \cite{tsus}, el cual se caracteriza por los siguientes parámetros.

\begin{multicols}{2}
\begin{itemize}
\item Componente \ac{TH}.
\item Longitud de onda $\lambda_p=950$ nm.
\item Tiempo de respuesta $t_r=800$ ns.
\item Corriente máxima de 0.1 A.
\end{itemize}
\end{multicols}

De forma análoga a los casos anteriores, presentamos el circuito necesario correspondiente a este actuador en la figura \ref{diseno:fig:ir}.

\figuraEx{Bitmap/Capitulo4/ir}{width=.3\textwidth}{diseno:fig:ir}%
{Emisor Infrarrojo Vishay TSUS5202.}{Emisor Infrarrojo Vishay TSUS5202.}

El único componente que encontramos es una resistencia, cuya función es la de limitar la corriente que circula por el diodo, puesto que si excede de la máxima especificada el \ac{IR} podría dejar de funcionar. Para no disminuir la potencia de emisión, que es directamente proporcional a la corriente de excitación, impondremos que dicha corriente sea tan similar a la máxima como sea posible. La calculamos como:

$$R_8 \geq {\frac {3.3V-0.7V}{0.1A}}=26\Omega$$

Para asegurar, escogemos un valor de resistencia de $33\Omega$, de forma que se tendrá una corriente de 87 mA.


%-------------------------------------------------------------------
\subsubsection{Buzzer}
%-------------------------------------------------------------------
\label{diseno:sec:buzzer}
%-------------------------------------------------------------------

Para el zumbador elegimos el modelo comercial de \textbf{TDK PS1720} \cite{buzzer}, el cual fue diseñado para aplicaciones de alarma, como corresponde en nuestro caso, y que tiene un precio de 0.75 \euro. La figura \ref{diseno:fig:buzz} muestra el circuito pasa su correcto funcionamiento.

\figuraEx{Bitmap/Capitulo4/buzz}{width=.5\textwidth}{diseno:fig:buzz}%
{Buzzer TDK PS1720.}{Buzzer TDK PS1720.}

Podemos observar varios componentes en este diseño. En primer lugar remarcamos la presencia del transistor NPN Q1, cuya función es la de hacer de amplificador de corriente a la entrada del zumbador. Además, en paralelo con el buzzer se introduce la resistencia R9 con el propósito de realizar la carga y la descarga del elemento piezoeléctrico. Finalmente, la resistencia R10 se introduce con propósitos de seguridad.

%-------------------------------------------------------------------
\subsubsection{LEDs}
%-------------------------------------------------------------------
\label{diseno:sec:leds}
%-------------------------------------------------------------------

Con el objeto de poder hacer depuración en etapas siguientes del proceso, y como salida visual de diferentes parámetros, añadimos dos \ac{LED}, verde y rojo, al diseño de la placa. Su circuito, similar al visto en la sección \ref{diseno:sec:ir} se presenta en la figura \ref{diseno:fig:led}.

\figuraEx{Bitmap/Capitulo4/led}{width=.3\textwidth}{diseno:fig:led}%
{LED de información y depuración.}{LED de información y depuración.}

En este caso, los valores de las resistencias han aumentado con respecto a lo visto en el caso del \ac{LED} \ac{IR}, puesto que en este caso nos basta con que el mismo tenga un nivel de iluminación en el que se permita discernir si está encendido o apagado, por lo que no es necesaria tanta corriente. En este sentido, hemos considerado que un valor de 330$\Omega$ es suficiente.

%-------------------------------------------------------------------
\section{Diseño de la placa de expansión}
%-------------------------------------------------------------------
\label{diseno:sec:placa}
%-------------------------------------------------------------------

En los siguientes subapartados se presenta la forma en la que los distintos componentes que ha sido objeto de análisis en la sección \ref{diseno:sec:eleccion} se combinan entre sí y cómo se integran dentro del nodo, el \ac{CNGD}.

%-------------------------------------------------------------------
\subsection{Diagrama de bloques}
%-------------------------------------------------------------------
\label{diseno:sec:bloques}
%-------------------------------------------------------------------

En el diagrama de bloques de la figura \ref{diseno:fig:bloques} presentamos las interfaces del \ac{MCU} y su conexión con los sensores y actuadores de nuestra placa. Asimismo, se presenta el pin del \textit{header} al que se conecta.

\figuraEx{Bitmap/Capitulo4/bloques}{width=.7\textwidth}{diseno:fig:bloques}%
{Diagrama de Bloques de la Placa de Expansión.}{Diagrama de Bloques de la Placa de Expansión.}

En adición, y a modo de resumen, presentamos en la tabla \ref{diseno:tab:ifaz} una relación de los componentes, tanto sensores como actuadores, la forma de comunicación y los pines del \textit{header} que ocupa, así como el periférico del \ac{MCU} del que hacen uso en relación con lo visto en la tabla \ref{previo:tab:headerspinout}.

\begin{table}[h]
\centering
\scalebox{1}{
\begin{tabular}{| c | c | c | c | c | c |}

\hline
Componente & Comercial & Puerto & Com. & Header & Función \\

\hline \hline
\multirow{2}{*}{Temperatura} & \multirow{2}{*}{MCP9800} & ALERT & GPIO & 16 & RB(15) \\\cline{3-6}
& & \multirow{2}{*}{I$^2$C} & SDA & 10 & SDA(2) \\\cline{1-2}
\multirow{3}{*}{Acelerómetro} & \multirow{3}{*}{MMA8453Q} & & SCK & 11 & SCK(2) \\\cline{3-6}
& & INT1 & \multirow{2}{*}{GPIO} & 9 & RD(8)  \\
& & INT2 &  & 3 & RB(11)  \\
\hline
Presencia & \multicolumn{2}{c|}{AMN 33112J} & CN & 33 & CN(15) \\
\hline
Luminosidad & \multicolumn{2}{c|}{APDS 9005} & ADC & 5 & AN(13) \\
\hline
\hline
Infrarrojo & \multicolumn{2}{c|}{TSUS 5202} & GPIO & 35 & RE(6) \\
\hline
Buzzer & \multicolumn{2}{c|}{PS1720} & GPIO & 2 & RB(3) \\
\hline
\multirow{2}{*}{LEDs} & \multicolumn{2}{c|}{Rojo} & \multirow{2}{*}{GPIO} & 23 & RE(5) \\
& \multicolumn{2}{c|}{Verde} & & 22 & RE(7) \\
\hline
\end{tabular}
}

\caption{Entradas y salidas de los \textit{headers} hacia la placa de expansión.
\label{diseno:tab:ifaz}}
\end{table} 

A la hora de considerar la asignación de los distintos pines a las entradas y salidas de los componentes, se tuvo en cuenta, a parte de que la función requerida estuviera disponible en el mismo, que no reutilizara ningún otro pin ya usado para hacer otras \textit{shields}, con lo que conseguiríamos que todos los diseños fueran apilables. En este sentido, evaluamos el uso que hacían de los headers las placas de expansión correspondientes al módulo RS232 y al cargador \cite{aguspfc} y a la del módulo de reprogramación \cite{northpfc}.

%-------------------------------------------------------------------
\subsection{Esquemático}
%-------------------------------------------------------------------
\label{diseno:sec:esquematico}
%-------------------------------------------------------------------

El esquemático, donde se aprecia todo el circuito que conforma la placa de expansión, se presenta en la figura \ref{diseno:fig:esquematico}.

\figuraEx{Bitmap/Capitulo4/esquematico}{width=\textwidth}{diseno:fig:esquematico}%
{Esquemático de la Placa de Expansión.}{Esquemático de la Placa de Expansión.}

Como peculiaridad, resaltar que las resistencias R1 y R2 son las responsables del \textit{pull-up} de las señales de los dos hilos del I$^2$C, que han sido referidas pero no reflejadas en apartados anteriores.

%-------------------------------------------------------------------
\section{Implementación en PCB}
%-------------------------------------------------------------------
\label{diseno:sec:pcb}
%-------------------------------------------------------------------

SADFQW 


%-------------------------------------------------------------------
\subsection{Lista de Materiales}
%-------------------------------------------------------------------
\label{diseno:sec:bom}
%-------------------------------------------------------------------

SDFSDFS

%-------------------------------------------------------------------
\subsection{Layout}
%-------------------------------------------------------------------
\label{diseno:sec:layout}
%-------------------------------------------------------------------

ÑOUIOÑUI


%-------------------------------------------------------------------
\section{Herramientas}
%-------------------------------------------------------------------
\label{diseno:sec:herramientas}
%-------------------------------------------------------------------


UYKJRTFRU7JRFU


%-------------------------------------------------------------------
\subsection{Altium Designer}
%-------------------------------------------------------------------

SDJGKFAH U

%-------------------------------------------------------------------
\subsubsection{Librería de componentes}
%-------------------------------------------------------------------


%-------------------------------------------------------------------
\subsection{Puesto de Soldadura}
%-------------------------------------------------------------------

FGHDG 

